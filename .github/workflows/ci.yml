name: CI - Tests and Linting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # Job 1: Linting e Code Quality
  # ============================================================================
  lint:
    name: Linting (Black, Ruff, MyPy)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black ruff mypy

      - name: ğŸ¨ Check formatting with Black
        run: |
          black --check src/ tests/
        continue-on-error: false

      - name: ğŸ” Lint with Ruff
        run: |
          ruff check src/ tests/
        continue-on-error: false

      - name: ğŸ·ï¸ Type check with MyPy
        run: |
          mypy src/amldo --ignore-missing-imports
        continue-on-error: true  # MyPy pode ter falsos positivos

  # ============================================================================
  # Job 2: Unit Tests
  # ============================================================================
  test-unit:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint  # Roda apÃ³s linting passar

    strategy:
      matrix:
        python-version: ['3.11', '3.12']
      fail-fast: false  # Continua mesmo se uma versÃ£o falhar

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: ğŸ§ª Run unit tests
        run: |
          pytest tests/unit/ \
            -v \
            --tb=short \
            -m "not integration and not slow" \
            --junitxml=junit/test-results-${{ matrix.python-version }}.xml

      - name: ğŸ“Š Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.python-version }}
          path: junit/test-results-*.xml

  # ============================================================================
  # Job 3: Integration Tests (apenas no main)
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test-unit
    if: github.ref == 'refs/heads/main'  # Apenas no main

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: ğŸ”— Run integration tests
        run: |
          pytest tests/integration/ \
            -v \
            -m integration \
            --tb=short
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        continue-on-error: true  # Integration pode falhar sem API key

  # ============================================================================
  # Job 4: Coverage Report
  # ============================================================================
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: test-unit

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: ğŸ“Š Generate coverage report
        run: |
          pytest tests/ \
            --cov=src/amldo \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term \
            -m "not integration and not slow"

      - name: ğŸ“¤ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ğŸ“Š Upload HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: htmlcov/

  # ============================================================================
  # Job 5: Build Check
  # ============================================================================
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: ğŸ—ï¸ Build package
        run: |
          python -m build

      - name: âœ… Check package
        run: |
          twine check dist/*

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # ============================================================================
  # Job 6: Security Scan
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install safety bandit

      - name: ğŸ”’ Check dependencies with Safety
        run: |
          safety check --json
        continue-on-error: true

      - name: ğŸ›¡ï¸ Security scan with Bandit
        run: |
          bandit -r src/amldo -f json -o bandit-report.json
        continue-on-error: true

      - name: ğŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json

  # ============================================================================
  # Job 7: Notify on Success/Failure
  # ============================================================================
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [lint, test-unit, coverage, build]
    if: always()

    steps:
      - name: âœ… All checks passed
        if: ${{ needs.lint.result == 'success' && needs.test-unit.result == 'success' }}
        run: |
          echo "âœ… All CI checks passed!"
          echo "Ready for deployment ğŸš€"

      - name: âŒ Some checks failed
        if: ${{ needs.lint.result == 'failure' || needs.test-unit.result == 'failure' }}
        run: |
          echo "âŒ Some CI checks failed"
          echo "Please review the errors above"
          exit 1
